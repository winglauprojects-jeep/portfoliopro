name: CI Pipeline

# Trigger on push to main, dev, or any feature branch
on:
  push:
    branches: [main, dev, "feature/*"]
  pull_request:
    branches: [main, dev]

jobs:
  test:
    name: Run Tests & Lint
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout Code
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2. Setup Node.js (Version 18 is stable for Next.js 14)
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      # 3. Install Dependencies (Clean install)
      - name: Install Dependencies
        run: npm ci

      # 4. Run Linting (Catches syntax/code style errors)
      - name: Lint Code
        run: npm run lint

      # 5. Run Tests
      # We pass --watchAll=false so it runs once and stops (CI mode)
      - name: Run Tests
        run: npm test -- --watchAll=false --passWithNoTests
        env:
          # We provide fake keys so the build doesn't crash.
          # Since we Mock Firebase in our tests, these real values aren't needed!
          NEXT_PUBLIC_FIREBASE_API_KEY: "mock-key"
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: "mock-domain"
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: "mock-project"
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: "mock-bucket"
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: "mock-sender"
          NEXT_PUBLIC_FIREBASE_APP_ID: "mock-app-id"
